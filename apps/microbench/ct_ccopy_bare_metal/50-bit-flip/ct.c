#include <stddef.h>
#include <stdint.h>

uint32_t ccopy(uint32_t src, uint32_t dst, uint32_t ctl)
{
    return dst ^ (-ctl & (src ^ dst));
}

uint32_t test_ccopy_loop(int loopcnt, unsigned char *e, uint32_t src, uint32_t dst)
{
    size_t elen;
    uint32_t k, ctl;
    int i = loopcnt;
    uint32_t r = 0x0;

    elen = (i + 7) >> 3;
    for (k = 0; k < ((uint32_t)elen << 3); k ++)
    {
        ctl = (e[elen - 1 - (k >> 3)] >> (k & 7)) & 1;
        r =  ccopy(src, dst, ctl);
    }

    return r;
    
}

int main(int argc, char* argv)
{
    volatile uint32_t ret;
    unsigned char e[128] = {    0x3f, 0xff, 0xff, 0xff,
                                0xff, 0xff, 0xf0, 0x00,
                                0x00, 0x00, 0x00, 0x00,
                                0x03, 0xff, 0xff, 0xff,
                                0xff, 0xff, 0xff, 0x00,
                                0x00, 0x00, 0x00, 0x00,
                                0x00, 0x3f, 0xff, 0xff,
                                0xff, 0xff, 0xff, 0xf0,
                                0x00, 0x00, 0x00, 0x00,
                                0x00, 0x03, 0xff, 0xff,
                                0xff, 0xff, 0xff, 0xff,
                                0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x3f, 0xff,
                                0xff, 0xff, 0xff, 0xff,
                                0xf0, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x03, 0xff,
                                0xff, 0xff, 0xff, 0xff,
                                0xff, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x3f,
                                0xff, 0xff, 0xff, 0xff,
                                0xff, 0xf0, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x03,
                                0xff, 0xff, 0xff, 0xff,
                                0xff, 0xff, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00,
                                0x3f, 0xff, 0xff, 0xff,
                                0xff, 0xff, 0xf0, 0x00,
                                0x00, 0x00, 0x00, 0x00,
                                0x03, 0xff, 0xff, 0xff,
                                0xff, 0xff, 0xff, 0x00,
                                0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00};

    volatile uint32_t src = 0xFF03B244;
    volatile uint32_t dst = 0xDEADBEEF;

    ret = test_ccopy_loop(100, e, src, dst);
    __asm__("addi x0, x1, 0\n\t");
    ret = test_ccopy_loop(100, e, src, dst);

    return 0;
}
